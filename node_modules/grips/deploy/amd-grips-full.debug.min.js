/* grips (c) 2012-2014 Kyle Simpson | http://getify.mit-license.org/ */
;(function(){Object.keys||(Object.keys=function(t){var n,r=[];for(n in t)t.hasOwnProperty(n)&&r.push(n);return r}),Array.isArray||(Array.isArray=function(t){return Object.prototype.toString(t)==="[object Array]"}),Object.create||(Object.create=function(t){function n(){}return n.prototype=t,new n}),Object.prototype.toJSON||(Object.prototype.toJSON=function(){function t(e){for(var t=0;t<r.length;t++)if(r[t]===e)return!0;return!1}function n(e){function i(e){if(typeof e=="object"){if(e!==null){if(Date===e.constructor||Number===e.constructor||Boolean===e.constructor||String===e.constructor||RegExp===e.constructor)return e;if(!t(e))return n(e)}return null}return e}var s,o,u;if(Array.isArray(e)){r.push(e),o=[];for(s=0;s<e.length;s++)o.push(i(e[s]));return r.pop(),o}if(typeof e=="object"){if(e!==null){if(Date===e.constructor||Number===e.constructor||String===e.constructor||Boolean===e.constructor||RegExp===e.constructor)return e;if(!t(e)){r.push(e),o={};for(s in e)e.hasOwnProperty(s)&&(u=i(e[s]),u!==null&&(o[s]=u));return r.pop(),o}}return null}return e}var r=[],i;return i=n(this),r=[],i},Object.defineProperty&&Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1})),function(t){function r(){function i(){}function s(){var e=t.grips;return t.grips=n,e}function o(e){e in b||(b[e]={collection:"",extend:null,partials:{}})}function u(e,t){o(e),b[e].extend=t}function a(e){var t,n,r;if(typeof e=="object"){if(e===null)return e;if(Array.isArray(e)){n=[];for(t=0;t<e.length;t++)typeof e[t]=="object"?r=a(e[t]):r=e[t],n.push(r)}else{e instanceof i?n=new i:n={};for(t in e)e.hasOwnProperty(t)&&(typeof (e[t]==="object")?r=a(e[t]):r=e[t],n[t]=r)}}else n=e;return n}function f(t,n,r,i){return r="["+t+"] "+r,i&&(r+="; "+i.toString()),new e(r,n,i?i.stack:null)}function l(t,n,r){var i=n.match(/^(.+)#/);i&&(i=i[1]);if(!i)throw new e("Missing collection ID: "+n)||w;o(i),b[i].partials[n.replace(/^.*#/,"#")]=function(n,s){var o,u;try{u=t(n,s)}catch(a){throw o=f(i,r,"Unexpected error",a),o.stack=a.stack,o}if(u instanceof Error)throw u;return u}}function c(e,t){var n="",r,i;t=t!==!1;if(Array.isArray(e))for(r=0;r<e.length;r++)n+=p(e[r],null,t);else if(typeof e=="object")for(i in e)e.hasOwnProperty(i)&&(n+=p(e[i],i,t));return n}function h(t,n){if(!n)throw new e("Missing collection ID")||w;return p(t,n,!1)}function p(e,t,n){var r;n=n!==!1;try{if(y.tokenizer.process(e,t))return y.parser.end(),y.generator.process(n)}catch(i){throw i instanceof y.tokenizer.TokenizerError||i instanceof y.parser.ParserError?i:(r=f(t,null,"Unexpected compilation error",i),r.stack=i.stack,r)}return!1}function d(e){var n=new Function(e);n.call(t)}function v(e,t){o(e),d(t)}function m(t,n,r){if(!t)return"";n=n||{},r=r||{};var i,s=!1,o,u,a=[],f=!1,l=!1;i=t.match(/^(.+)#/),i&&(i=i[1],f=!0);if(!f&&E.length>0)i=E[E.length-1];else if(!f||E.length>0&&E[E.length-1]===i){if(!i)throw new e("Required collection ID missing: "+t)||w}else E.push(i),l=!0;if(i in b){t=t.replace(/^(.+)#/,"#"),u=i+t,S.push(u);for(o=0;o<S.length-1;o++)if(S[o]===u)throw new e("Recursive template include: "+u)||w;f?a.push(i):a=a.concat(E);if(!(t in b[i].partials)&&b[i].extend){u=b[i].extend;while(u&&u in b)a.push(u),u=b[u].extend}for(o=0;o<a.length;o++)if(t in b[a[o]].partials){s=b[a[o]].partials[t](n,r);break}}if(s!==!1)return S.pop(),l&&E.pop(),s;throw new e("["+t+"] Template not found")||w}function g(e,t){return typeof e=="string"&&(t.html&&/[&<>"]/.test(e)&&(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")),t.string&&(e=e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\t/g,"\\t")),t.url&&(e=encodeURIComponent(e))),e}var e=function(){function n(){}function r(e,r,i){var s=this===t?new n:this;return s.message=e,s.ref=r,s.stack=i,s}return n.prototype=r.prototype=Object.create(ReferenceError.prototype),r.prototype.constructor=r,r.prototype.toString=function(){var t="TemplateError: "+this.message;return this.ref&&(t+="; "+JSON.stringify(this.ref)),t=t.replace(/[\n\r]+/g," ").replace(/\s+/g," "),this.stack&&(t+="\n"+this.stack),t},r}(),y,b={},w=new Error("Unknown error"),E=[],S=[];return y={extend:u,cloneObj:a,definePartial:l,strEscapes:g,compile:c,compileChunk:h,compileCollection:p,initialize:d,initializeCollection:v,render:m,error:f,TemplateError:e,noConflict:s,sandbox:r,RangeLiteralHash:i,collections:b},y}var n=t.grips;t.grips=r()}(this),function(t,n){function r(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}function i(e,t){e=Math.max(0,e);var n,r={raw:e,line:1,col:e};for(n=0;n<l[t].length;n++){if(l[t][n]>e)break;r.line=n+1,r.col=e-l[t][n]}return r}function o(){var e;do e=Math.floor(Math.random()*1e9);while(e in f);return e}function u(e,t){function u(e){var t,n,r,i;for(r=0;r<e.length;r++)if(e[r].type===T){t=n=r;for(i=t+1;i<e.length;i++){n=i;if(e[i].type!==T){n=i-1;break}}if(n>t){for(i=t+1;i<=n;i++)e[t].val+=e[i].val;e.splice(t+1,n-t)}else r=i}return e}function w(e){for(var t=0;t<e.length;t++)e[t].type===T&&(e[t].val=e[t].val.replace(/\\\\/g,"\\"));return e}function O(){var o,f;R&&(z=new r({type:null,val:R,pos:i(j,t)}),/^\s+$/.test(R)?z.type=N:z.type=T,a.push(z));if(I){f=e.substring(0,B-I[0].length);if(!!f&&!k.test(f)){a.push(new r({type:T,val:I[0],pos:i(B-I[0].length,t)}));return}if(I[0]==="{$}")a.push(new r({type:d,val:I[0],pos:i(B-I[0].length,t)}));else{if(I[0]!=="{$")return new s("Unrecognized token",new r({type:TOKEN_TAG_UNKNOWN,val:I[0],pos:i(B-I[0].length,t)}))||A;z=new r({type:c,val:I[0],pos:i(B-I[0].length,t)}),a.push(z);if(!(B<e.length-1&&(I=e.substr(B).match(/^(?:(?:~|escape\s+)[hsuHSU]+|[~:+=*\/%#]|(?:(?:define|extend|insert|print|partial|loop|let|comment|raw|escape)\b))/))))return new n.parser.ParserError("Expected Tag type-signifier",new r({type:T,val:e.substr(B,1),pos:i(B,t)}))||A;a.push(new r({type:v,val:I[0],pos:i(B,t)})),B+=I[0].length}}a=a.concat(o=w(u(a.splice(F-a.length)))),U=n.parser.nodify(o,t),F=a.length}function M(){var e,o;if(R){if(o=R.match(/[^a-z0-9_$\s]/i))return new s("Unrecognized token",new r({type:T,val:o[0],pos:i(j+o.index,t)}))||A;a.push(new r({type:T,val:R,pos:i(j,t)}))}if(I)if(I[0]==="$}")a.push(new r({type:h,val:I[0],pos:i(B-I[0].length,t)}));else if(I[0]==="}")a.push(new r({type:p,val:I[0],pos:i(B-I[0].length,t)}));else{if(/^\s+$/.test(I[0])){a.push(new r({type:N,val:I[0],pos:i(B-I[0].length,t)}));return}if(/^["']$/.test(I[0]))z=new r({type:0,val:I[0],pos:i(B-I[0].length,t)}),I[0]==='"'?z.type=S:z.type=E,a.push(z),L[n.parser.LITERAL]=new RegExp(I[0],"g"),L[n.parser.LITERAL].lastIndex=0;else if(/^(?:\.\.)|[:=?\(\)\[\],\-.!]$/.test(I[0]))a.push(new r({type:x,val:I[0],pos:i(B-I[0].length,t)}));else if(I[0]==="|")a.push(new r({type:y,val:I[0],pos:i(B-I[0].length,t)}));else if(I[0]==="@")a.push(new r({type:b,val:I[0],pos:i(B-I[0].length,t)}));else{if(!/^~[hsuHSU]*$/.test(I[0])){a.push(new r({type:T,val:I[0],pos:i(B-I[0].length,t)}));return}a.push(new r({type:C,val:I[0],pos:i(B-I[0].length,t)}))}}a=a.concat(e=w(u(a.splice(F-a.length)))),U=n.parser.nodify(e,t),F=a.length}function _(){var e,s;a[a.length-1].type!==T&&a.push(new r({type:T,val:"",pos:i(j,t)})),R&&(a[a.length-1].val+=R),I&&(s=a[a.length-1].val,!s||k.test(s)?(a.push(new r({type:g,val:I[0],pos:i(B-I[0].length,t)})),a=a.concat(e=w(u(a.splice(F-a.length)))),U=n.parser.nodify(e,t),F=a.length):(s&&!k.test(s)&&(a[a.length-1].val=a[a.length-1].val.substr(0,a[a.length-1].val.length-1)),a[a.length-1].val+=I[0]))}function D(){var e,s;if(I){s=a[a.length-1].val;if(!s||k.test(s))a.push(new r({type:m,val:I[0],pos:i(B-I[0].length,t)})),a=a.concat(e=w(u(a.splice(F-a.length)))),U=n.parser.nodify(e,t),F=a.length}}function P(){var e,s;a[a.length-1].type!==T&&a.push(new r({type:T,val:"",pos:i(j,t)})),R&&(a[a.length-1].val+=R),I&&(s=a[a.length-1].val,!s||k.test(s)?(a.push(new r({type:I[0]==='"'?S:E,val:I[0],pos:i(B-I[0].length,t)})),a=a.concat(e=w(u(a.splice(F-a.length)))),U=n.parser.nodify(e,t),F=a.length,L[n.parser.STRING_LITERAL]=null):(s&&!k.test(s)&&(a[a.length-1].val=a[a.length-1].val.substr(0,a[a.length-1].val.length-1)),a[a.length-1].val+=I[0]))}var H,B=0,j=0,F=a.length,I,q,R,U,z,W,X,V=/\r?\n/g,$=[O,M,_,D,P];t||(t=o(),f[t]=!0,t="chunk_"+t),t in l||(l[t]=[0]);while((!U||U===!0)&&B<e.length){R="",U=null,q=n.parser.state;if(q===n.parser.INVALID)break;H=L[q];if(!H){U=new n.parser.ParserError("Invalid parser state")||A;break}H.lastIndex=B,I=H.exec(e);if(I)j=B,B=H.lastIndex,j<B-I[0].length&&(R=e.substring(j,B-I[0].length));else{j=B,B=e.length,R=e.substr(j);if(!R)break}if(R){V.lastIndex=0;while(X=V.exec(R))l[t].push(j+X.index+X[0].length)}V.lastIndex=0;while(X=V.exec(I))l[t].push(j+R.length+X.index+X[0].length);W=$[q]();if(W&&W!==!0)break;if(U&&U!==!0)break}if(W instanceof s||W instanceof n.parser.ParserError)throw W;if(U instanceof s||U instanceof n.parser.ParserError)throw U;if(W instanceof Error)throw W;if(U instanceof Error)throw U;return!0}r.prototype.toString=function(){return"`"+this.val+"`; line: "+this.pos.line+" position: "+this.pos.col+"; token-type: "+this.type};var s=function(){function n(){}function r(e,r){var i=this===t?new n:this;return i.message=e,i.token=r,i}return n.prototype=r.prototype=Object.create(SyntaxError.prototype),r.prototype.constructor=r,r.prototype.toString=function(){return"TokenizerError: "+this.message+"; "+this.token.toString().replace(/[\n\r]+/g," ").replace(/\s+/g," ")},r}(),a=[],f={},l={},c=0,h=1,p=2,d=3,v=4,m=5,g=6,y=7,b=8,w=9,E=10,S=11,x=12,T=13,N=14,C=15,k=/(?:[^\\]|(?:^|[^\\])(?:\\\\)+)$/,L=[/\{\$\}|\{\$/g,/\$\}|\}|(?:\.\.)|(?:~[hsuHSU]*)|["':=@\|?\(\)\[\],\-.!#]|\s+/g,/%\$\}/g,/\/\$\}/g],A=new Error("Unknown error");n.tokenizer={OPEN:c,SIMPLE_CLOSE:h,BLOCK_HEAD_CLOSE:p,BLOCK_FOOTER:d,SIGNIFIER:v,COMMENT_CLOSE:m,RAW_CLOSE:g,PIPE:y,AT:b,STRING_LITERAL:w,SINGLE_QUOTE:E,DOUBLE_QUOTE:S,OPERATOR:x,GENERAL:T,WHITESPACE:N,TILDE:C,process:u,lineCol:i,TokenizerError:s,Token:r}}(this,this.grips),function(t,n){function r(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}function s(e,t){function s(e){if(e.type===n.tokenizer.OPEN)c=new r({parent:null,type:null,token:e,def:[],children:[],complete:!1}),v?(c.parent=v,v.children.push(c)):(delete c.parent,d.push(c)),v=c,J.state=b;else if(e.type===n.tokenizer.GENERAL)c=new r({parent:null,type:T,token:e,val:e.val,complete:!0}),v?(c.parent=v,v.children.push(c)):(delete c.parent,d.push(c));else if(v&&e.type===n.tokenizer.WHITESPACE)c=new r({parent:v,type:T,token:e,val:e.val,complete:!0}),v.children.push(c);else if(e.type===n.tokenizer.BLOCK_FOOTER){if(!v||v.close_header!==n.tokenizer.BLOCK_HEAD_CLOSE)return J.state=x,new i("Unexpected Tag",e)||K;v.complete=!0,v=v.parent}}function o(e){function s(){if(v.type===L||v.type===k||v.type===A||v.type===$){c=new r({parent:v,type:null,token:null,def:[]});if(!v.main_expr&&v.type===A)v.main_expr=c,c.type=D;else if(v.type===L||v.type===k){if(!!v.main_expr)return J.state=x,new i("Unexpected token",e)||K;v.main_expr=c,c.type=D,v.type===k&&(c.collection_id=t)}else c.type=P;v.def.push(c),v=c}}if(e.type===n.tokenizer.SIGNIFIER){if(!v||v.type!=null)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;/^(?:\:|define)$/.test(e.val)?v.type=C:/^(?:\+|extend)$/.test(e.val)?v.type=N:/^(?:\=|insert|print)$/.test(e.val)?v.type=L:/^partial$/.test(e.val)?v.type=k:/^(?:\*|loop)$/.test(e.val)?v.type=A:/^(?:#|let)$/.test(e.val)?v.type=$:/^(?:\%|raw)$/.test(e.val)?v.type=O:/^(?:\/|comment)$/.test(e.val)?v.type=M:/^(?:escape|(?:~|escape\s+)[hsuHSU]*)$/.test(e.val)&&(v.type=V),v.type===N||v.type===L?(v.close_header=n.tokenizer.SIMPLE_CLOSE,delete v.children):v.type===k?v.close_header=n.tokenizer.SIMPLE_CLOSE:v.type===C||v.type===A||v.type===$?v.close_header=n.tokenizer.BLOCK_HEAD_CLOSE:v.type===V?(v.close_header=n.tokenizer.BLOCK_HEAD_CLOSE,v.escapes={},/(?:~.*|escape\s+.*)h/i.test(e.val)&&(v.escapes.html=!0),/(?:~.*|escape\s+.*)s/i.test(e.val)&&(v.escapes.string=!0),/(?:~.*|escape\s+.*)u/i.test(e.val)&&(v.escapes.url=!0),/\b[hsu]$/i.test(e.val)||(v.escapes.string=!0),delete v.def):v.type===O?(v.val="",J.state=w,delete v.def,delete v.children):v.type===M&&(v.val="",J.state=E,delete v.def,delete v.children);if(!v.parent&&v.type!==N&&v.type!==C&&v.type!==M||v.parent&&(v.type===N||v.type===C))return J.state=x,new i("Unexpected Tag",v)||K}else if(e.type===n.tokenizer.WHITESPACE){if(v){if(v.type!==N&&v.type!==C&&v.type!==k&&v.type!==L&&v.type!==A&&v.type!==$&&v.type!==V&&v.type!==P&&v.type!==D)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.def&&v.def.length>0&&v.def.push(new r({parent:v,type:z,token:e}))}}else if(e.type===n.tokenizer.AT){if(!v||v.type!==L||v.def.length!==0)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.type=k}else if(e.type===n.tokenizer.TILDE){if(!v||v.type!==k&&v.type!==L||v.def.length!==0)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.escapes={},/h/i.test(e.val)&&(v.escapes.html=!0),/s/i.test(e.val)&&(v.escapes.string=!0),/u/i.test(e.val)&&(v.escapes.url=!0),/[hsu]/i.test(e.val)||(v.escapes.string=!0)}else if(e.type===n.tokenizer.SINGLE_QUOTE||e.type===n.tokenizer.DOUBLE_QUOTE){if(!v||v.type!==N&&v.type!==C&&v.type!==k&&v.type!==P&&v.type!==D)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;J.state=S,c=new r({parent:v,type:null,token:e,val:"",delimiter:e.val});if(v.type===C||v.type===N){if(!!v.id)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.id=c,c.type=_,v.type===C&&(c.collection_id=t)}else if(v.type===k){if(!!v.main_expr)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.main_expr=c,c.type=_,c.collection_id=t}else c.type=q;v.def.push(c),v=c}else if(e.type===n.tokenizer.OPERATOR){if(!v)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;/[\(\[]/.test(e.val)&&s();if(v.type!==P&&v.type!==D)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.token||(v.token=e);if(e.val==="-"&&v.def.length>0&&v.def[v.def.length-1].type!==z&&(v.def[v.def.length-1].type!==W||!/(?:\.\.)|\[/.test(v.def[v.def.length-1].val)))return new n.tokenizer.TokenizerError("Unexpected token",e)||K;v.def.push(new r({parent:v,type:W,token:e,val:e.val}))}else if(e.type===n.tokenizer.PIPE){if(!v)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;if(v.type===P||v.type===D){if(v.def.length===0)return J.state=x,new i("Expected EXPR",e)||K;v=v.parent}if(v.type===$&&v.def.length===0)return J.state=x,new i("Expected EXPR",e)||K;if(!v.id&&(v.type===C||v.type===N))return J.state=x,new i("Expected #id for Tag",v)||K;if(!(v.type===C||v.type===A||v.type===$||v.type===k&&!v.context_expr))return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;c=new r({parent:v,type:P,token:null,def:[]}),v.type===k&&(v.context_expr=c),v.def.push(c),v=c}else if(e.type===n.tokenizer.SIMPLE_CLOSE){if(!v)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;if(v.type===P||v.type===D)v=v.parent;if(!v.id&&v.type===N)return J.state=x,new i("Expected #id for Tag",v)||K;if(v.close_header!==n.tokenizer.SIMPLE_CLOSE)return J.state=x,new i("Unexpected Tag closure",e)||K;v.type===k&&!v.context_expr&&(c=new r({parent:v,type:P,token:null,def:[]}),c.def.push(new r({parent:c,type:T,token:null,val:"$"})),v.context_expr=c,v.def.push(c)),v.complete=!0,J.state=y,v=v.parent}else if(e.type===n.tokenizer.BLOCK_HEAD_CLOSE){if(!v)return J.state=x,new n.tokenizer.TokenizerError("Unexpected token",e)||K;if(v.type===P||v.type===D)v=v.parent;if(v.type===$&&v.def.length===0)return J.state=x,new i("Expected EXPR",e)||K;if(!v.id&&v.type===C)return J.state=x,new i("Expected #id for Tag",v)||K;if(v.close_header!==n.tokenizer.BLOCK_HEAD_CLOSE)return J.state=x,new i("Unexpected Tag closure",e)||K;J.state=y}else if(e.type===n.tokenizer.GENERAL){if(!v)return J.state=x,new i("Unexpected token",e)||K;s();if(v.type!==P&&v.type!==D)return J.state=x,new i("Unexpected token",e)||K;v.token||(v.token=e),/^\d+$/.test(e.val)&&v.def.length>0&&v.def[v.def.length-1].type===W&&v.def[v.def.length-1].val==="-"?v.def[v.def.length-1]=new r({parent:v,type:T,token:new n.tokenizer.Token({type:n.tokenizer.GENERAL,val:"-"+e.val,pos:n.tokenizer.lineCol(e.pos.raw-1,t)}),val:"-"+e.val}):v.def.push(new r({parent:v,type:T,token:e,val:e.val}))}}function u(e){if(e.type===n.tokenizer.GENERAL)v.token.type!==n.tokenizer.GENERAL&&(v.token=e),v.val+=e.val;else{if(e.type!==n.tokenizer.RAW_CLOSE)return new i("Unexpected token",e)||K;v.complete=!0,v=v.parent,J.state=y}}function a(e){e.type===n.tokenizer.COMMENT_CLOSE&&(v=v.parent,v?v.children.pop():d.pop(),J.state=y)}function f(e){if(e.type===n.tokenizer.GENERAL)v.token.type!==n.tokenizer.GENERAL&&(v.token=e),v.val+=e.val;else{if(e.type!==n.tokenizer.SINGLE_QUOTE&&e.type!==n.tokenizer.DOUBLE_QUOTE||v.delimiter!==e.val)return new i("Unexpected token",e)||K;v=v.parent,J.state=b}}var l,c,h,p=[s,o,u,a,f];t!==m&&(m&&d.push(new r({type:X,close:m,complete:!0})),m=t,d.push(new r({type:X,start:t,complete:!0})));for(l=0;l<e.length;l++){if(J.state===x)return new i("Invalid parser state")||K;h=p[J.state](e[l]);if(h)return h}return!0}function o(){m&&d.push(new r({type:X,close:m,complete:!0})),m=null}function u(e){var t,n,r,i;for(r=0;r<e.length;r++)if(e[r].type===T){t=n=r;for(i=t+1;i<e.length;i++){n=i;if(e[i].type!==T){n--;break}}if(n>t){for(i=t+1;i<=n;i++)e[t].token.val+=e[i].token.val,e[t].val+=e[i].val;e.splice(t+1,n-t)}else r=i}return a(e)}function a(e){var t,n,r,i;for(r=0;r<e.length;r++)if(e[r].type===z){t=n=r;for(i=t+1;i<e.length;i++){n=i;if(e[i].type!==z){n--;break}}if(n>t){for(i=t+1;i<=n;i++)e[t].token.val+=e[i].token.val,e[t].val+=e[i].val;e.splice(t+1,n-t)}else r=i}return e}function f(e){var t=[],n=0,r=e.length-1;while(n<=r){e[n].type===z&&n++,e[r].type===z&&r--;if(!(n<r)||e[n].type!==z&&e[r].type!==z)break}return n<=r&&(t=e.slice(n,r+1)),t}function l(e){var t=[],n=0,r=e.length-1,i,s=0;while(n<r){e[n].type===z&&n++,e[r].type===z&&r--;if(n<r&&e[n].type!==z&&e[r].type!==z){if(e[n].type!==W||e[n].val!=="("||e[r].type!==W||e[r].val!==")")break;for(i=n+1;i<r;i++)if(e[i].type===W){e[i].val==="("?s++:e[i].val===")"&&s--;if(s<0)break}if(s!==0)break;n++,r--}}return n<=r&&(t=e.slice(n,r+1)),t}function c(e){for(var t=0;t<e.length;t++)e[t].type===W&&(e.splice(t,1),t--)}function h(e){function t(e){var t,n,r=[],i=!1;if(e.length<5)return!1;if(e[0].type!==W||e[0].val!=="[")return!1;r.push(e[0]);for(t=1;t<e.length;t++){n=e[t];if(n.type===z)continue;r.push(n);if(n.type===W){if(n.val==="]")break;if(!/(?:\.\.)|[\-,]/.test(n.val))return!1;/(?:\.\.)|,/.test(n.val)&&(i=!0)}}return r.length<5||!i?!1:r}function s(e){function t(e,t,n){var i,s;e=l(e),i=new r({parent:u,type:t,token:e[0].token,def:e}),x=n(i);if(x)return x;for(s=0;s<i.def.length;s++)i.def[s].parent=i;return i}var n,i,s=[],o,u,a,f,c;if(e.length>0){for(n=0;n<e.length;n++){i=e[n];if(i.type===W&&/[?:]/.test(i.val)){if(i.val==="?"){if(!!u)return!1;u=new r({parent:null,type:F,token:e[0].token,def:[]}),a=t(s,I,p);if(a instanceof Error)throw a;c=new r({parent:u,type:j,token:null,def:[]}),o=new r({parent:c,type:q,token:null,val:"",delimiter:'"'}),c.def.push(o),s=[]}else if(i.val===":"){if(!u||!!f)return!1;f=t(s,j,y);if(f instanceof Error)throw f;s=[]}}else s.push(i)}if(s.length>0){if(!u)return!1;if(!f){f=t(s,j,y);if(f instanceof Error)throw f}else{c=t(s,j,y);if(c instanceof Error)throw c}s=[]}if(a&&f)return u.def.push(a,f,c),u}}function o(e){var t;if((t=e.val.match(/#/g))&&t.length>1)return new i("Unexpected extra #id",e)||K;if(e.parent.type===C){if(!e.val)return new i("Expected #id",e)||K;if(!/^#/.test(e.val))return new i("Unexpected text before #id",e)||K;if(!/^#[a-z0-9_\-$.+=\/]/i.test(e.val))return new i("Expected #id",e)||K;if(t=e.val.match(/(#.*?)([^a-z0-9_\-$.+=\/]).*$/i))return new n.tokenizer.TokenizerError("Unexpected token",new n.tokenizer.Token({type:n.tokenizer.GENERAL,val:t[2],pos:n.tokenizer.lineCol(e.token.pos.raw+t.index+t[1].length,m)}))||K;e.val=e.collection_id+e.val}else if(e.parent.type===N){if(t=e.val.match(/#/))return new n.tokenizer.TokenizerError("Unexpected token",new n.tokenizer.Token({type:n.tokenizer.GENERAL,val:"#",pos:n.tokenizer.lineCol(e.token.pos.raw+t.index,m)}))||K}else if(e.parent.type===k){if(!e.val||!/#.+/.test(e.val))return new i("Expected #id",e)||K;if(t=e.val.match(/(#.*?)([^a-z0-9_\-$.+=\/]).*$/i))return new n.tokenizer.TokenizerError("Unexpected token",new n.tokenizer.Token({type:n.tokenizer.GENERAL,val:t[2],pos:n.tokenizer.lineCol(e.token.pos.raw+t.index+t[1].length,m)}))||K}}function p(e){function t(e){while(e.parent&&(e=e.parent))if(e.type===n.parser.TAG_LOOP)return!0;return!1}function r(e){while(e.parent&&(e=e.parent))if(e.type===n.parser.MAIN_REF_EXPR||e.type===n.parser.ASSIGNMENT_EXPR)return e.type===n.parser.MAIN_REF_EXPR;return!1}var s,o,u,a,f=[];if(!(e.def&&e.def.length>0))return new i("Expected EXPR",e)||K;for(s=0;s<e.def.length;s++){if(e.def[s].type===z)continue;u=a,a=e.def[s];if(a.type===W){if(!/[.!\[\]\(\)]/.test(a.val))return new n.tokenizer.TokenizerError("Unexpected token",a.token)||K;if(s===e.def.length-1&&!/[\]\)]/.test(a.val))return new n.tokenizer.TokenizerError("Unexpected token",a.token)||K;if(u)if(u.type===W){if(a.val==="("&&!/[!\(\[]/.test(u.val))return new i("Invalid EXPR",a)||K;if(a.val==="!"&&!/[!\(]/.test(u.val))return new i("Invalid EXPR",a)||K;if(/[.\[\]\)]/.test(a.val)&&!/[\]\)]/.test(u.val))return new i("Invalid EXPR",a)||K}else{if(u.type===T&&!/[.\[\]\)]/.test(a.val))return new i("Invalid EXPR",a)||K;if(u.type===q&&!/[\]\)]/.test(a.val))return new i("Invalid EXPR",a)||K}else if(!/[!\(]/.test(a.val))return new i("Invalid EXPR",a)||K;if(/[\[\(]/.test(a.val))f.push(a.val);else if(/[\]\)]/.test(a.val)){if(!(f.length>0&&(f[f.length-1]==="["&&a.val==="]"||f[f.length-1]==="("&&a.val===")")))return new i("Unbalanced EXPR",a)||K;f.pop()}}else if(a.type===T){if(/^\d/.test(a.val)){if(!/^\d+$/.test(a.val))return new i("Invalid identifier in EXPR",a)||K;if(u&&(u.type!==W||!/[\(\[]/.test(u.val)))return new i("Unexpected number",a)||K}o=r(a);if(e.def.length===1&&a.val==="_"&&!o&&a.parent.parent.context_expr!==a.parent)return new i("Invalid identifier in EXPR",a)||K;if(a.val==="_"&&!(o&&t(a.parent.parent)||!o&&t(a)))return new i("Unexpected Identifier in EXPR",a)||K;if(u){if(u.type===T)return new i("Invalid EXPR",a)||K;if(u.type===W&&!/[.!\(\[]/.test(u.val))return new i("Invalid EXPR",a)||K}}else if(a.type===q&&u&&(u.type!==W||!/[\[\(]/.test(u.val)))return new i("Unexpected string literal",a)||K}if(f.length>0)return new i("Unbalanced EXPR",e)||K}function d(e){if(!e.def||e.def.length!==5)return new i("Expected range literal",e)||K;if(e.def[1].type!==T||!/^-?\d+$/.test(e.def[1].val))return new i("Invalid range literal",e.def[1])||K;if(e.def[3].type!==T||!/^-?\d+$/.test(e.def[3].val))return new i("Invalid range literal",e.def[3])||K;if(e.def[2].type!==W||e.def[2].val!=="..")return new i("Invalid range literal",e.def[2])||K}function v(e){var t,n,r;if(!(e.def&&e.def.length>=5))return new i("Expected set literal",e)||K;for(t=1;t<e.def.length-1;t++){n=r,r=e.def[t];if(r.type===q){if(n&&(n.type!==W||n.val!==","))return new i("Invalid set literal",r)||K}else{if(r.type!==W||r.val!==",")return new i("Invalid set literal",r)||K;if(!n||n.type!==q)return new i("Invalid set literal",r)||K}}if(e.def[e.def.length-2].type!==q)return new i("Invalid set literal",e.def[e.def.length-2])||K}function g(e){var n,o,u,a,h,p,m=[],g,w;if(!(e.def&&e.def.length>0))return new i("Expected assignment statement",e)||K;for(n=0;n<e.def.length;n++){if(e.def[n].type===z)continue;u=a,a=e.def[n];if(!!g){h=l(e.def.slice(n));if(h.length===0)return new i("Expected EXPR",a)||K;w=new r({parent:e,type:j,token:h[0].token,def:[]}),p=s(h);if(!p){w.def=h,x=y(w);if(x)return x}else w.def=[p];for(o=0;o<w.def.length;o++)w.def[o].parent=w;break}if(a.type===W)if(a.val==="="){g=new r({parent:e,type:B,token:m[0].token,def:m});if(!m[0]||m[0].type!==B||!m[1]||m[1].type!==U&&m[1].type!==R){x=b(g);if(x)return x}for(o=0;o<g.def.length;o++)g.def[o].parent=g;m=[]}else if(a.val==="["){h=t(e.def.slice(n));if(h){p=new r({parent:null,type:B,token:e.def[0].token,def:e.def.slice(0,n)}),x=b(p),x||(m=[p],p=new r({parent:null,type:R,token:a.token,def:h}),x=d(p),x&&(p.type=U,x=v(p)),x?x=new i("Invalid bracket literal",a)||K:(m.push(p),n+=h.length-1,c(p.def)));if(x)return x}else m.push(a)}else{if(!u||!/[.\[\]]/.test(a.val))return new i("Invalid statement EXPR",a)||K;m.push(a)}else m.push(a)}if(!g||!w)return new i("Invalid assignment statement",e)||K;g.def=f(g.def),w.def=f(w.def),e.def=[g,w],e.type=H}function y(e){var t,r,s,o=!1;if(!(e.def&&e.def.length>0))return new i("Expected EXPR",e)||K;for(t=0;t<e.def.length;t++){r=e.def[t];if(r.type===W){if(r.val==="!")return new n.tokenizer.TokenizerError("Unexpected token",r.token)||K}else if(r.type===T)if(!/^\d+$/.test(r.val))o=!0;else if(!o)return new i("Unexpected number",r)||K}s=p(e);if(s)return s}function b(e){var t,n,r,s;if(!(e.def&&e.def.length>0))return new i("Expected EXPR",e)||K;for(t=0;t<e.def.length;t++){if(e.def[t].type===z)continue;n=r,r=e.def[t];if(r.type===q&&(!n||n.type!==W||n.val!=="["))return new i("Unexpected string literal",r)||K}s=y(e);if(s)return s}var w,E,S,x,M;if(e.type===N){if(!e.id||!(w=h(e.id)))throw new i("Expected collection ID for Extend Tag",e)||K;e.id=w;if(e.def&&e.def.length>0){e.def[0]=e.id;if(e.def.length>1){for(M=1;M<e.def.length;M++)if(e.def[M].type!==z)throw new i("Unexpected",e.def[M])||K;e.def=[e.id]}}return e}if(e.type===C){if(!e.id||!(w=h(e.id)))throw new i("Expected #id for Tag",e)||K;e.id=w;if(e.def&&e.def.length>0){w=[e.id],S=f(e.def.slice(1));for(M=0;M<S.length;M++)E=h(S[M]),E&&w.push(E);e.def=w}if(e.children&&e.children.length>0){e.children=u(e.children),w=[];for(M=0;M<e.children.length;M++)E=h(e.children[M]),E&&w.push(E);e.children=u(w)}return e}if(e.type===A){if(!e.main_expr||!(w=h(e.main_expr)))throw new i("Expected EXPR for Tag",e)||K;e.main_expr=w;if(e.def&&e.def.length>0){w=[e.main_expr],S=f(e.def.slice(1));for(M=0;M<S.length;M++)E=h(S[M]),E&&w.push(E);e.def=w}if(e.children&&e.children.length>0){e.children=u(e.children),w=[];for(M=0;M<e.children.length;M++)E=h(e.children[M]),E&&w.push(E);e.children=u(w)}return e}if(e.type===$){if(!(e.def&&e.def.length>0))throw new i("Expected EXPR in Tag",e)||K;w=f(e.def);for(M=0;M<w.length;M++)E=h(w[M]),E&&(w[M]=E);e.def=w;if(e.children&&e.children.length>0){e.children=u(e.children),w=[];for(M=0;M<e.children.length;M++)E=h(e.children[M]),E&&w.push(E);e.children=u(w)}return e}if(e.type===L){if(!e.main_expr||!(w=h(e.main_expr)))throw new i("Expected EXPR for Tag",e)||K;e.main_expr=w;if(e.def&&e.def.length>0){if(e.def.length>1)for(M=1;M<e.def.length;M++)if(e.def[M].type!==z)throw new i("Unexpected",e.def[M])||K;e.def=[e.main_expr]}return e}if(e.type===k){if(!e.main_expr||!(w=h(e.main_expr)))throw new i("Expected template reference EXPR for Tag",e)||K;e.main_expr=w,e.context_expr.type=B,e.context_expr.def=f(e.context_expr.def),x=y(e.context_expr);if(x)throw x;return e.def=[e.main_expr,e.context_expr],e}if(e.type===O)return e.type=T,e;if(e.type===_){if(x=o(e))throw x;return e}if(e.type===P){if(!(e.def&&e.def.length>0))throw new i("Expected EXPR",e)||K;e.def=a(e.def),e.def=f(e.def),x=g(e);if(x)throw x;return e}if(e.type===D){if(!(e.def&&e.def.length>0))throw new i("Expected EXPR",e)||K;w=[];for(M=0;M<e.def.length;M++)e.def[M].type!==z&&w.push(e.def[M]);e.def=l(w);if((w=t(e.def))&&w.length===e.def.length){w=new r({parent:e,type:null,token:e.token,def:w});for(M=0;M<w.def.length;M++)w.def[M].parent=w;x=d(e),x?(x=v(e),x||(w.type=U)):w.type=R;if(x)throw new i("Invalid bracket literal",e)||K;c(w.def),e.def=[w]}else e.parent.type===L||e.parent.type===A?x=b(e):e.parent.type===k&&(x=y(e));if(x)throw x;return e}if(e.type!==T)return e.type===X?(e.start?m=e.start:e.close&&(m=null),e):e;if(!e.parent&&e.token.type!==n.tokenizer.WHITESPACE)throw new i("Unexpected text outside of tag",e)||K;if(e.val!=="")return e}function p(){var e;while(g<d.length&&!e&&d[g].complete)e=h(d[g++]);return e}r.prototype.toString=function(t){function n(e){return(e.delimiter||'"')+(e.val||"")+(e.delimiter||'"')}function r(e){var t,n="";if(e.def)for(var t=0;t<e.def.length;t++)n+=e.def[t].toString();return n}function i(e){var t,n="";if(e.children)for(var t=0;t<e.children.length;t++)n+=e.children[t].toString();return n}function s(e){var t="";return e.escapes&&(t+="~",e.escapes.html&&(t+="h"),e.escapes.string&&(t+="s"),e.escapes.url&&(t+="u")),t}var o,u,a;if(this.type===C)u="{$: ",this.id&&(u+=this.id.toString().replace(/(["']).*#/,"$1#")),u+=" }";else if(this.type===N)u="{$+ ",this.id&&(u+=this.id.toString()),u+=" $}";else if(this.type===k)u="{$="+(this.escapes?s(this):"")+" @",this.main_expr&&(u+=this.main_expr.toString(),a=this.context_expr.toString(),a!=="$"&&(u+=" | "+a)),u+=" $}";else if(this.type===L)u="{$="+(this.escapes?s(this):"")+" ",this.main_expr&&(u+=this.main_expr.toString()),u+=" $}";else if(this.type===A)u="{$* ",this.main_expr&&(u+=this.main_expr.toString()),u+=" }";else if(this.type===V)u="{$"+s(this)+"}";else if(this.type===$)u="{$# "+r(this)+" $}";else if(this.type===O)u="{$% "+i(this)+" %$}";else if(this.type===P||this.type===D)u=r(this);else if(this.type===H)u=this.def[0].toString()+" = "+this.def[1].toString();else if(this.type===F)u=this.def[0].toString()+" ? "+this.def[1].toString()+" : "+this.def[2].toString();else if(this.type===I||this.type===B||this.type===j)u=r(this);else if(this.type===q||this.type===_)u=n(this);else if(this.type===R)u="["+this.def[0].val+".."+this.def[1].val+"]";else if(this.type===U){u="";for(o=0;o<this.def.length;o++)u+=(u!==""?",":"")+n(this.def[o]);u="["+u+"]"}else this.type===T||this.type===W?u=this.val:this.type===z?u=" ":u=JSON.stringify(this);return t&&this.token&&(u+="; "+this.token),u};var i=function(){function i(){}function s(e,n){var r=this===t?new i:this;return r.message=e,r.ref=n,r}return i.prototype=s.prototype=Object.create(SyntaxError.prototype),s.prototype.constructor=s,s.prototype.toString=function(){var t="",i,s;return this.ref&&(this.ref instanceof n.tokenizer.Token?t="; "+this.ref.toString():this.ref instanceof r?(this.ref.token?(i=this.ref.token.pos.col,(this.ref.type===q||this.ref.type===_)&&i--,i="line: "+this.ref.token.pos.line+" position: "+Math.max(0,i)+"; "):i="",s=this.ref.toString().replace(/[\n\r]+/g," ").replace(/\s+/g," "),s!==""&&(this.ref.type!==q&&this.ref.type!==_&&(s="`"+s+"`"),s+="; "),t="; "+s+i+"node-type: "+this.ref.type):t="; "+this.ref),"ParserError: "+this.message+t},s}(),d=[],v,m="",g=0,y=0,b=1,w=2,E=3,S=4,x=5,T=0,N=1,C=2,k=3,L=4,A=5,O=6,M=7,_=8,D=9,P=10,H=11,B=12,j=13,F=14,I=15,q=16,R=17,U=18,z=19,W=20,X=21,V=22,$=23,J,K=new Error("Unknown error");J={OUTSIDE:y,INSIDE:b,RAW:w,COMMENT:E,LITERAL:S,INVALID:x,TEXT:T,TAG_EXTEND:N,TAG_DEFINE:C,TAG_INCL_TMPL:k,TAG_INSERT_VAR:L,TAG_LOOP:A,TAG_RAW:O,TAG_COMMENT:M,ID:_,MAIN_REF_EXPR:D,GENERAL_EXPR:P,ASSIGNMENT_EXPR:H,REF_EXPR:B,VAL_EXPR:j,CONDITIONAL_EXPR:F,BOOLEAN_EXPR:I,STRING_LITERAL:q,RANGE_LITERAL:R,SET_LITERAL:U,WHITESPACE:z,OPERATOR:W,COLLECTION_MARKER:X,TAG_ESCAPE:V,TAG_LET:$,state:y,nodify:s,end:o,parseNextNode:p,ParserError:i,Node:r},n.parser=J}(this,this.grips),function(t,n){function r(e){return e.replace(/\\([\s\S])|(")/g,"\\$1$2")}function i(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function s(e){return e.replace(/\\(?!\\*\")/g,"\\\\")}function o(e){var t;return t={type:e.type,pos:null,val:e.toString()},e.type===n.parser.ID&&e.token&&e.token.val&&(t.val=e.token.val),e.token&&(t.pos={line:e.token.pos.line,col:e.token.pos.col}),JSON.stringify(t)}function u(e){return e=e.replace(/[^a-z0-9_$]/ig,"_"),e}function a(){var e="";return O.sort&&(e+="function __sort_fn__(a,b){ return a-b; }"),e+="var partial = G.definePartial, clone = G.cloneObj",e+=", error = G.error",O.extend&&(e+=", extend = G.extend"),O.esc&&(e+=", esc = G.strEscapes"),O.unerr&&(e+=', unerr = new Error("Unknown error")'),O.RLH&&(e+=", RLH = G.RangeLiteralHash"),O.cID&&(e+=', cID = "'+O.cID_value+'"'),e+=";",e}function f(e){var t="";return t+="(function __"+u(e.start)+"__"+"(G){",t+="/*startCollection*/",t}function l(){return"})(this.grips||grips);"}function c(e){return v(e.def[0])+" ? "+v(e.def[1])+" : "+v(e.def[2])}function h(e){return e.delimiter+e.val+e.delimiter}function p(e){var t="";return t+="for (i="+e.def[0].val+"; i",e.def[0].val<=e.def[1].val?t+="<="+e.def[1].val+"; i++) {":t+=">="+e.def[1].val+"; i--) {",t}function d(e){var t,n="",r,i;i="";for(t=0;t<e.def.length;t++)r=e.def[t],i+=(i!==""?",":"")+h(r);return n+="var _set = ["+i+"];",n+="for (i=0; i<"+e.def.length+"; i++) {",n}function v(e){var t,r="",i,s;if(e.type===n.parser.STRING_LITERAL||e.type===n.parser.ID)r+=h(e);else{if(!(e.def&&e.def.length>0))throw new n.parser.ParserError("Invalid EXPR",e)||A;if(e.def[0].type===n.parser.CONDITIONAL_EXPR)r+=c(e.def[0]);else for(t=0;t<e.def.length;t++)s=i,i=e.def[t],i.type===n.parser.TEXT?(i.val.match(/^\d+$/)||i.val.match(/^[_\$](?=(?:[^a-z0-9_$]|$))/i)||s&&s.type===n.parser.OPERATOR&&s.val==="."||(r+="$$."),r+=i.val):i.type===n.parser.OPERATOR?r+=i.val:i.type===n.parser.STRING_LITERAL&&(r+=h(i))}return r}function m(e){var t="",n,r;return n=e.def[0],r=v(n.def[0]),t+=r+" = new RLH();",t+=p(n.def[1]),n=e.def[1].def[0],t+=r+'["" + i] = ('+v(n.def[0])+" === i) ? ",t+=v(n.def[1])+" : "+v(n.def[2])+";",t+="}",O.RLH=!0,t}function g(e){var t="",n,r;return n=e.def[0],r=v(n.def[0]),t+=r+" = {};",t+=d(n.def[1]),n=e.def[1].def[0],t+=r+"[_set[i]] = ("+v(n.def[0])+" === _set[i]) ? ",t+=v(n.def[1])+" : "+v(n.def[2])+";",t+="}",t}function y(e){var t="",r;return r=e.def[0],r.def[r.def.length-1].type===n.parser.RANGE_LITERAL?t+=m(e):r.def[r.def.length-1].type===n.parser.SET_LITERAL?t+=g(e):(t+=v(r),t+=" =",t+=v(e.def[1]),t+=";"),t}function b(e){return O.extend=!0,O.cID=!0,'extend(cID,"'+e.id.val+'");'}function w(e){var t,n="",r;n+="partial(function __"+u(e.id.val.replace(/^.*#/,""))+"__"+"($,$$){",n+="$$ = clone($$) || {};",n+='var i, ret = "", ret2, _;';for(t=1;t<e.def.length;t++)r=e.def[t],n+="try {",n+=y(r),n+="} catch (err"+t+") {",n+="return error(cID,"+o(r)+',"Assignment failed",err'+t+");",n+="}",O.cID=!0;return n+=C(e),n+="return ret;",n+='},"'+e.id.val+'"',n+=","+o(e),n+=");",n}function E(e){var t="";return t+="ret2 = esc((function __escape__ (){",t+='var ret = "", ret2;',t+=C(e),t+="return ret;",t+="})(),"+JSON.stringify(e.escapes)+");",t+=k("ret","ret2"),O.esc=!0,t}function S(e){var t,r="",i;r+="ret2 = (function __loop__ (){",r+="function __iter__($,$$,value,key,index){",r+='var i, ret = "", ret2, _;',r+="if (value == null) return ret;",r+="$$ = clone($$);",r+="_ = {",r+="value: value,",r+="key: key,",r+="index: index,",r+="even: (index % 2) === 0,",r+="odd: (index % 2) === 1,",r+="first: (index === 0),",r+="last: (index === len - 1)",r+="};";for(t=1;t<e.def.length;t++)i=e.def[t],r+="try {",r+=y(i),r+="} catch (err"+t+") {",r+="return error(cID,"+o(i)+',"Assignment failed in loop iteration: " + JSON.stringify(_,["key","index"]),err'+t+");",r+="}",O.cID=!0;return r+=C(e),r+="return ret;",r+="}",r+='var i, j = 0, len, ret = "", it, tmp;',r+="try {",e.main_expr.def[0].type===n.parser.SET_LITERAL?(r+=d(e.main_expr.def[0]),r+="len = _set.length;",r+='ret2 = __iter__($,$$,_set[i],""+i,i);',r+=k("ret","ret2"),r+="}"):e.main_expr.def[0].type===n.parser.RANGE_LITERAL?(r+="len = "+(Math.abs(e.main_expr.def[0].def[0].val-e.main_expr.def[0].def[1].val)+1)+";",r+=p(e.main_expr.def[0]),r+='ret2 = __iter__($,$$,i,""+i,j++);',r+=k("ret","ret2"),r+="}"):(r+="it = "+v(e.main_expr)+";",r+="if (it == null) {",r+='return "";',r+="}",r+="if (Array.isArray(it)) {",r+="len = it.length;",r+="for (i=0; i<len; i++) {",r+='ret2 = __iter__($,$$,it[i],""+i,i);',r+=k("ret","ret2"),r+="}",r+='} else if (typeof it === "object") {',r+="tmp = Object.keys(it);",r+="len = tmp.length;",r+="if (it instanceof RLH) {",r+="tmp.sort(__sort_fn__);",r+="}",r+="for (i=0; i<len; i++) {",r+="ret2 = __iter__($,$$,it[tmp[i]],tmp[i],i);",r+=k("ret","ret2"),r+="}",r+="} else {",r+="return ",r+="error(cID,"+o(e.main_expr)+',"Invalid loop-iterator reference") || ',O.cID=!0,r+="unerr;",r+="}",O.sort=!0,O.RLH=!0,O.unerr=!0),r+="} catch (err) {",r+="return error(cID,"+o(e.main_expr)+',"Failed loop iteration",err);',r+="}",O.cID=!0,r+="return ret;",r+="})();",r+=k("ret","ret2"),r}function x(e){var t,n="",r;n+="ret2 = (function __let__ ($,$$){",n+="$$ = clone($$) || {};",n+='var i, ret = "", ret2, _;';for(t=0;t<e.def.length;t++)r=e.def[t],n+="try {",n+=y(r),n+="} catch (err"+t+") {",n+="return error(cID,"+o(r)+',"Assignment failed",err'+t+");",n+="}",O.cID=!0;return n+=C(e),n+="return ret;",n+="})($,$$);",n+=k("ret","ret2"),n}function T(e){var t="",n;return n=v(e.context_expr),t+="try {",t+="ret2 = "+n+";",t+="} catch (err) {",t+="return error(cID,"+o(e.context_expr)+',"Include template context reference failed",err);',t+="}",O.cID=!0,t+="try {",t+="ret2 = G.render("+v(e.main_expr)+",ret2,$$);",n=o(e.main_expr),t+="} catch (err) {",t+="if (err instanceof G.TemplateError) {",t+="err.ref = "+n+";",t+="return err;",t+="} else {",t+="return error(cID,"+n+',"Include template reference failed",err);',t+="}",t+="}",O.cID=!0,e.escapes&&(t+="ret2 = esc(ret2,"+JSON.stringify(e.escapes)+");",O.esc=!0),t+=k("ret","ret2"),t}function N(e){var t="",n=v(e.main_expr);return t+="try {",e.escapes?(t+="ret += esc("+n+","+JSON.stringify(e.escapes)+");",O.esc=!0):t+="ret += "+n+";",t+="} catch (err) {",t+="return error(cID,"+o(e.main_expr)+',"Insert reference failed",err);',t+="}",O.cID=!0,t}function C(e){var t,o="",u;for(t=0;t<e.children.length;t++)u=e.children[t],u.type===n.parser.TEXT?o+='ret += "'+i(s(r(u.val)))+'";':u.type===n.parser.TAG_LOOP?o+=S(u):u.type===n.parser.TAG_LET?o+=x(u):u.type===n.parser.TAG_INCL_TMPL?o+=T(u):u.type===n.parser.TAG_INSERT_VAR?o+=N(u):u.type===n.parser.TAG_ESCAPE&&(o+=E(u));return o}function k(e,t){var n="";return n+="if ("+t+" instanceof G.TemplateError) {",n+="return "+t+";",n+="} else {",n+=e+" += "+t+";",n+="}",n}function L(e){var t,r=[],i="",s="",o,u;while(t=n.parser.parseNextNode()){r.push(t);if(t.type===n.parser.COLLECTION_MARKER)t.start?(O={},o=f(t),O.cID_value=t.start,i+=o,s+=o):t.close&&(u=a(O),o=l(t),i+=o,i=i.replace(/\/\*startCollection\*\//,u),s+=o,s=s.replace(/\/\*startCollection\*\//,u),e&&n.initializeCollection(t.close,i),i="");else if(t.type===n.parser.TAG_EXTEND){if(!(r.length>1&&r[r.length-2].type===n.parser.COLLECTION_MARKER))throw new n.parser.ParserError("Unexpected Extend Tag",t)||A;o=b(t),i+=o,s+=o}else{if(t.type!==n.parser.TAG_DEFINE)throw new n.parser.ParserError("Unexpected text outside of tag",t)||A;o=w(t),i+=o,s+=o}}return s}var A=new Error("Unknown error"),O;n.generator={process:L}}(this,this.grips);var t=this.grips;typeof define=="function"&&define.amd&&define(t)}).call({});